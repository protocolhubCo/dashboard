<!DOCTYPE html>
<html>
  <head>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
    <style>
      body {
        margin: 0;
        padding: 0;
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100%;
        overflow: hidden;
      }

      canvas {
        max-width: 100%;
        height: auto; /* Ensures it scales proportionally */
      }
    </style>
  </head>
  <body>
    <canvas id="stackedBarChart"></canvas>
    <script>
      const apiKey = "944alidwz6py81e6xly1mh0ap";

      const carerRegisterAPI =
        "https://api.adalo.com/v0/apps/c8dc57c5-a121-4498-814f-35379f73a5fa/collections/t_059juy5qau0rxqccr5oq8x38o";
      const userAPI =
        "https://api.adalo.com/v0/apps/c8dc57c5-a121-4498-814f-35379f73a5fa/collections/t_01c3b6d144094994b8ac9fc0fdb1f5fc";

      async function fetchData() {
        const params = new URLSearchParams(window.location.search);
        const loggedInUserEmail = params.get("email");

        if (!loggedInUserEmail) {
          console.error("No email provided in URL parameters");
          return [];
        }

        const headers = {
          "Content-Type": "application/json",
          Authorization: `Bearer ${apiKey}`,
        };

        try {
          const [carerRegisterResponse, userResponse] = await Promise.all([
            fetch(carerRegisterAPI, { headers }),
            fetch(userAPI, { headers }),
          ]);

          const carerRegisterData = await carerRegisterResponse.json();
          const userData = await userResponse.json();

          const carerRecords = carerRegisterData.records || [];
          const userRecords = userData.records || [];

          // Filter relationships using emails
          const filteredCarerRelationships = carerRecords.filter((entry) => {
            const isCarer =
              entry["Carer Name"] === loggedInUserEmail &&
              entry["Approved?"]?.toLowerCase() === "yes";
            const isBeingCaredFor =
              entry["User Email"] === loggedInUserEmail &&
              entry["Approved?"]?.toLowerCase() === "yes";

            return isCarer || isBeingCaredFor;
          });

          // Map filtered relationships to user details
          const relatedUsers = filteredCarerRelationships
            .map((entry) => {
              const relatedUser = userRecords.find(
                (user) =>
                  user["Email"] === entry["User Email"] ||
                  user["Email"] === entry["Carer Name"]
              );

              if (relatedUser) {
                return {
                  name:
                    entry["User name"] ||
                    relatedUser["Full Name"] ||
                    entry["Carer Name"],
                  completed: parseInt(relatedUser["Total Completed"]) || 0,
                  remaining: parseInt(relatedUser["Total Remaining"]) || 0,
                };
              }
              return null;
            })
            .filter(Boolean);

          // Add "You" as the logged-in user
          const loggedInUserDetails = userRecords.find(
            (user) => user["Email"] === loggedInUserEmail
          );

          if (loggedInUserDetails) {
            relatedUsers.unshift({
              name: "You",
              completed: parseInt(loggedInUserDetails["Total Completed"]) || 0,
              remaining: parseInt(loggedInUserDetails["Total Remaining"]) || 0,
            });
          }

          return relatedUsers;
        } catch (error) {
          console.error("Error fetching data:", error);
          return [];
        }
      }

      async function renderChart() {
        const data = await fetchData();

        if (!data.length) {
          console.error("No data available to render chart");
          return;
        }

        const labels = data.map((entry) => entry.name);
        const completedData = data.map((entry) => entry.completed);
        const remainingData = data.map(
          (entry) => entry.completed + entry.remaining
        );

        const maxValue = Math.max(...remainingData);
        const maxYAxis = Math.ceil((maxValue / 54) * 100 + 10);

        const chartData = {
          labels: labels,
          datasets: [
            {
              label: "Completed",
              data: completedData.map((val) => (val / 54) * 100),
              backgroundColor: "rgba(75, 192, 192, 0.8)", // Teal color
            },
            {
              label: "Remaining",
              data: remainingData.map((val) => (val / 54) * 100),
              backgroundColor: "rgba(200, 200, 200, 0.8)", // Light grey color
              borderRadius: {
                topLeft: 10,
                topRight: 10, // Round the top-left and top-right corners
                bottomLeft: 0,
                bottomRight: 0, // Keep bottom corners sharp
              },
            },
          ],
        };

        const options = {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            x: {
              stacked: true,
              ticks: {
                display: true,
              },
            },
            y: {
              beginAtZero: true,
              stacked: true,
              max: maxYAxis,
              title: {
                display: true,
                text: "% of protocols chosen",
              },
            },
          },
          plugins: {
            legend: {
              display: true,
            },
            datalabels: {
              display: true,
              color: "#4F4F4F",
              anchor: "center",
              align: "center",
              font: {
                size: 12,
                weight: "normal",
              },
              formatter: (value, context) => {
                if (context.dataset.label === "Remaining") {
                  return `${Math.round((value * 54) / 100)}`;
                }
                return `${Math.round((value * 54) / 100)}`;
              },
            },
          },
        };

        const ctx = document.getElementById("stackedBarChart").getContext("2d");
        new Chart(ctx, {
          type: "bar",
          data: chartData,
          options: options,
        });
      }

      renderChart();
    </script>
  </body>
</html>
