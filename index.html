<!DOCTYPE html>
<html>
  <head>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
    <style>
      body {
        margin: 0;
        padding: 0;
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100%;
        overflow: hidden;
      }

      canvas {
        max-width: 100%;
        height: auto; /* Ensures it scales proportionally */
      }
    </style>
  </head>
  <body>
    <canvas id="stackedBarChart"></canvas>
    <script>
      // API Key
      const apiKey = "944alidwz6py81e6xly1mh0ap";

      // API Endpoints
      const carerRegisterAPI =
        "https://api.adalo.com/v0/apps/c8dc57c5-a121-4498-814f-35379f73a5fa/collections/t_059juy5qau0rxqccr5oq8x38o";
      const userAPI =
        "https://api.adalo.com/v0/apps/c8dc57c5-a121-4498-814f-35379f73a5fa/collections/t_01c3b6d144094994b8ac9fc0fdb1f5fc";

      async function fetchData() {
        const loggedInUserEmail = "loggedInUser@example.com"; // Replace dynamically as needed

        // Headers for authentication
        const headers = {
          "Content-Type": "application/json",
          Authorization: `Bearer ${apiKey}`,
        };

        // Fetch data from Carer Register
        const carerRegisterResponse = await fetch(carerRegisterAPI, { headers });
        const carerRegisterData = await carerRegisterResponse.json();

        // Fetch data from User Collection
        const userResponse = await fetch(userAPI, { headers });
        const userData = await userResponse.json();

        // Filter and process data
        const filteredCarerRelationships = carerRegisterData.filter((entry) => {
          const isCarer =
            entry["Carer Name"] === loggedInUserEmail &&
            entry["Approved?"].toLowerCase() === "yes";
          const isBeingCaredFor =
            entry["User Email"] === loggedInUserEmail &&
            entry["Approved?"].toLowerCase() === "yes";
          return isCarer || isBeingCaredFor;
        });

        const relatedUsers = filteredCarerRelationships
          .map((entry) => {
            const userEmail = entry["User Email"];
            const userDetails = userData.find(
              (user) => user["Email"] === userEmail
            );

            if (userDetails) {
              return {
                name: entry["User name"] || userDetails["Full Name"],
                completed: userDetails["Total Completed"],
                remaining: userDetails["Total Remaining"],
              };
            }
            return null;
          })
          .filter(Boolean);

        const loggedInUserDetails = userData.find(
          (user) => user["Email"] === loggedInUserEmail
        );
        if (loggedInUserDetails) {
          relatedUsers.unshift({
            name: "You",
            completed: loggedInUserDetails["Total Completed"],
            remaining: loggedInUserDetails["Total Remaining"],
          });
        }

        return relatedUsers;
      }

      async function renderChart() {
        const data = await fetchData();

        // Prepare chart labels and datasets
        const labels = data.map((entry) => entry.name);
        const completedData = data.map((entry) => entry.completed);
        const remainingData = data.map(
          (entry) => entry.completed + entry.remaining
        );

        // Find max value for Y-axis
        const maxValue = Math.max(...remainingData);
        const maxYAxis = Math.ceil((maxValue / 54) * 100 + 10);

        // Data structure for stacked bars
        const chartData = {
          labels: labels,
          datasets: [
            {
              label: "Completed",
              data: completedData.map((val) => (val / 54) * 100), // Convert to percentage
              backgroundColor: "rgba(75, 192, 192, 0.8)", // Teal color
            },
            {
              label: "Remaining",
              data: remainingData.map((val) => (val / 54) * 100), // Convert to percentage
              backgroundColor: "rgba(200, 200, 200, 0.8)", // Light grey color
              borderRadius: {
                topLeft: 10,
                topRight: 10, // Round the top-left and top-right corners
                bottomLeft: 0,
                bottomRight: 0, // Keep bottom corners sharp
              },
            },
          ],
        };

        // Chart configuration options
        const options = {
          responsive: true,
          maintainAspectRatio: false, // Ensures the chart adjusts to fit the WebView container
          plugins: {
            legend: {
              display: true, // Show the legend
            },
            title: {
              display: false, // Removes the title heading
            },
            datalabels: {
              display: true, // Enable datalabels
              color: "#4F4F4F", // Dark grey color for labels
              anchor: "center", // Position inside the bar
              align: "center",
              font: {
                size: 12,
                weight: "normal", // Lighter font weight
              },
              formatter: (value, context) => {
                if (context.dataset.label === "Remaining") {
                  return `${Math.round((value * 54) / 100)}`;
                }
                return `${Math.round((value * 54) / 100)}`;
              },
            },
          },
          scales: {
            x: {
              stacked: true, // Stack the bars
              grid: {
                display: false, // Hide grid lines
              },
              ticks: {
                display: true, // Show X-axis labels (User, Friend1, Friend2)
              },
            },
            y: {
              stacked: true, // Stack the bars
              beginAtZero: true,
              max: maxYAxis, // Dynamically set max Y-axis value
              grid: {
                display: true, // Show grid lines for better readability
              },
              ticks: {
                display: true, // Show Y-axis percentage points
                callback: function (value) {
                  return value + "%"; // Add percentage symbol to Y-axis ticks
                },
              },
              title: {
                display: true,
                text: "% of protocols chosen",
              },
            },
          },
        };

        // Render the chart
        const ctx = document.getElementById("stackedBarChart").getContext("2d");
        new Chart(ctx, {
          type: "bar",
          data: chartData,
          options: options,
          plugins: [ChartDataLabels], // Include the datalabels plugin
        });
      }

      renderChart();
    </script>
  </body>
</html>
