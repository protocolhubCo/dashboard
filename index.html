<!DOCTYPE html>
<html>
  <head>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
    <style>
      body {
        margin: 0;
        padding: 0;
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100%;
        overflow: hidden;
      }

      canvas {
        max-width: 100%;
        height: auto; /* Ensures it scales proportionally */
      }
    </style>
  </head>
  <body>
    <canvas id="stackedBarChart"></canvas>
    <script>
      // Helper function to get URL parameters
      function getURLParams() {
        const params = new URLSearchParams(window.location.search);
        const result = {
          userCompleted: parseInt(params.get('userCompleted')) || 0,
          userChosen: parseInt(params.get('userChosen')) || 0,
        };

        // Dynamically add friends if they exist
        for (let i = 1; params.has(`friend${i}Name`); i++) {
          result[`friend${i}`] = {
            name: params.get(`friend${i}Name`),
            completed: parseInt(params.get(`friend${i}Completed`)) || 0,
            chosen: parseInt(params.get(`friend${i}Chosen`)) || 0,
          };
        }

        return result;
      }

      const ctx = document.getElementById('stackedBarChart').getContext('2d');
      const params = getURLParams();

      const totalProtocols = 54; // Total possible protocols

      // Labels and dataset generation based on URL parameters
      const labels = ['User'];
      const completedData = [
        (params.userCompleted / totalProtocols) * 100, // Convert to percentage
      ];
      const chosenData = [
        (params.userChosen / totalProtocols) * 100, // Convert to percentage
      ];

      // Add friends dynamically
      Object.keys(params)
        .filter((key) => key.startsWith('friend'))
        .forEach((friendKey) => {
          const friend = params[friendKey];
          labels.push(friend.name);
          completedData.push((friend.completed / totalProtocols) * 100);
          chosenData.push((friend.chosen / totalProtocols) * 100);
        });

      // Find the maximum chosen percentage
      const maxChosenPercentage = Math.max(...chosenData);

      // Data structure for stacked bars
      const data = {
        labels: labels,
        datasets: [
          {
            label: 'Completed',
            data: completedData, // Completed percentages
            backgroundColor: 'rgba(75, 192, 192, 0.8)', // Teal color
          },
          {
            label: 'Chosen',
            data: chosenData, // Total chosen percentages
            backgroundColor: 'rgba(200, 200, 200, 0.8)', // Light grey color
            borderRadius: {
              topLeft: 10,
              topRight: 10, // Round the top-left and top-right corners
              bottomLeft: 0,
              bottomRight: 0, // Keep bottom corners sharp
            },
          },
        ],
      };

      // Configuration options for stacked bar chart
      const options = {
        responsive: true,
        maintainAspectRatio: false, // Ensures the chart adjusts to fit the WebView container
        plugins: {
          legend: {
            display: true, // Show the legend
          },
          title: {
            display: false, // Removes the title heading
          },
          datalabels: {
            display: true, // Enable datalabels
            color: '#4F4F4F', // Dark grey color for labels
            anchor: 'center', // Position inside the bar
            align: 'center',
            font: {
              size: 12,
              weight: 'normal', // Lighter font weight
            },
            formatter: (value, context) => {
              if (context.dataset.label === 'Chosen') {
                // Display the total chosen
                return Math.round((value * totalProtocols) / 100); 
              }
              return Math.round((value * totalProtocols) / 100); // Display the completed value
            },
          },
        },
        scales: {
          x: {
            stacked: true, // Stack the bars
            grid: {
              display: false, // Hide grid lines
            },
            ticks: {
              display: true, // Show X-axis labels (User, Friend1, Friend2)
            },
          },
          y: {
            stacked: true, // Stack the bars
            beginAtZero: true,
            max: Math.ceil(maxChosenPercentage / 10) * 10, // Dynamically set max Y-axis value
            grid: {
              display: true, // Show grid lines for better readability
            },
            ticks: {
              display: true, // Show Y-axis percentage points
              callback: function (value) {
                return value + '%'; // Add percentage symbol to Y-axis ticks
              },
            },
            title: {
              display: true,
              text: '% of available protocols', // Add Y-axis title
              color: '#4F4F4F',
              font: {
                size: 14,
              },
            },
          },
        },
      };

      // Render the chart
      new Chart(ctx, {
        type: 'bar',
        data: data,
        options: options,
        plugins: [ChartDataLabels], // Include the datalabels plugin
      });
    </script>
  </body>
</html>
