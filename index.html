<!DOCTYPE html>
<html>
  <head>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
    <style>
      body {
        margin: 0;
        padding: 0;
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100%;
        overflow: hidden;
      }

      canvas {
        max-width: 100%;
        height: auto; /* Ensures it scales proportionally */
      }
    </style>
  </head>
  <body>
    <canvas id="stackedBarChart"></canvas>
    <script>
      const apiKey = "944alidwz6py81e6xly1mh0ap";

      const carerRegisterAPI =
        "https://api.adalo.com/v0/apps/c8dc57c5-a121-4498-814f-35379f73a5fa/collections/t_059juy5qau0rxqccr5oq8x38o";
      const userAPI =
        "https://api.adalo.com/v0/apps/c8dc57c5-a121-4498-814f-35379f73a5fa/collections/t_01c3b6d144094994b8ac9fc0fdb1f5fc";

      async function fetchData() {
        const params = new URLSearchParams(window.location.search);
        const loggedInUserEmail = params.get("email");

        if (!loggedInUserEmail) {
          console.error("No email provided in URL parameters");
          return [];
        }

        const headers = {
          "Content-Type": "application/json",
          Authorization: `Bearer ${apiKey}`,
        };

        try {
          console.log("Fetching Carer Register data...");
          const [carerRegisterResponse, userResponse] = await Promise.all([
            fetch(carerRegisterAPI, { headers }),
            fetch(userAPI, { headers }),
          ]);

          const carerRegisterData = await carerRegisterResponse.json();
          const userData = await userResponse.json();

          console.log("Carer Register Data:", carerRegisterData);
          console.log("User Data:", userData);

          const filteredCarerRelationships = carerRegisterData.filter((entry) => {
            const isCarer =
              entry["Carer Name"] === loggedInUserEmail &&
              entry["Approved?"]?.toLowerCase() === "yes";
            const isBeingCaredFor =
              entry["User Email"] === loggedInUserEmail &&
              entry["Approved?"]?.toLowerCase() === "yes";
            return isCarer || isBeingCaredFor;
          });

          console.log("Filtered Carer Relationships:", filteredCarerRelationships);

          const relatedUsers = filteredCarerRelationships
            .map((entry) => {
              const userEmail = entry["User Email"];
              const userDetails = userData.find(
                (user) => user["Email"] === userEmail
              );

              if (userDetails) {
                return {
                  name: entry["User name"] || userDetails["Full Name"],
                  completed: userDetails["Total Completed"] || 0,
                  remaining: userDetails["Total Remaining"] || 0,
                };
              }
              return null;
            })
            .filter(Boolean);

          const loggedInUserDetails = userData.find(
            (user) => user["Email"] === loggedInUserEmail
          );

          if (loggedInUserDetails) {
            relatedUsers.unshift({
              name: "You",
              completed: loggedInUserDetails["Total Completed"] || 0,
              remaining: loggedInUserDetails["Total Remaining"] || 0,
            });
          }

          console.log("Final Chart Data:", relatedUsers);

          return relatedUsers;
        } catch (error) {
          console.error("Error fetching data:", error);
          return [];
        }
      }

      async function renderChart() {
        const data = await fetchData();

        if (!data.length) {
          console.error("No data available to render chart");
          return;
        }

        console.log("Rendering chart with data:", data);

        const labels = data.map((entry) => entry.name);
        const completedData = data.map((entry) => entry.completed);
        const remainingData = data.map(
          (entry) => entry.completed + entry.remaining
        );

        const maxValue = Math.max(...remainingData);
        const maxYAxis = Math.ceil((maxValue / 54) * 100 + 10);

        const chartData = {
          labels: labels,
          datasets: [
            {
              label: "Completed",
              data: completedData.map((val) => (val / 54) * 100),
              backgroundColor: "rgba(75, 192, 192, 0.8)",
            },
            {
              label: "Remaining",
              data: remainingData.map((val) => (val / 54) * 100),
              backgroundColor: "rgba(200, 200, 200, 0.8)",
            },
          ],
        };

        const options = {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              beginAtZero: true,
              max: maxYAxis,
              title: {
                display: true,
                text: "% of protocols chosen",
              },
            },
          },
        };

        const ctx = document.getElementById("stackedBarChart").getContext("2d");
        new Chart(ctx, {
          type: "bar",
          data: chartData,
          options: options,
        });
      }

      renderChart();
    </script>
  </body>
</html>
